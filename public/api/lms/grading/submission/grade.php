<?php
declare(strict_types=1); require_once dirname(__DIR__,2) . '/_common.php'; $user=lms_require_roles(['ta','manager','admin']); $in=lms_json_input();
$submissionId=(int)($in['submission_id']??0); if($submissionId<=0){lms_error('validation_error','submission_id required',422);} $score=(float)($in['score']??0); $max=(float)($in['max_score']??100);
$pdo=db(); $sub=$pdo->prepare('SELECT submission_id, assignment_id, course_id, student_user_id FROM lms_submissions WHERE submission_id=:id'); $sub->execute([':id'=>$submissionId]); $s=$sub->fetch(); if(!$s){lms_error('not_found','Submission not found',404);} if($user['role_name']==='ta'){ $chk=$pdo->prepare('SELECT 1 FROM lms_assignment_tas WHERE assignment_id=:a AND ta_user_id=:u'); $chk->execute([':a'=>(int)$s['assignment_id'],':u'=>(int)$user['user_id']]); if(!$chk->fetchColumn()){lms_error('forbidden','TA not assigned',403);} }
$pdo->prepare('INSERT INTO lms_grades (course_id,student_user_id,assignment_id,submission_id,status,score,max_score,feedback,graded_by) VALUES (:c,:stu,:a,:s,\'draft\',:score,:max,:f,:u) ON DUPLICATE KEY UPDATE score=VALUES(score), max_score=VALUES(max_score), feedback=VALUES(feedback), graded_by=VALUES(graded_by), status=\'draft\', updated_at=CURRENT_TIMESTAMP')->execute([':c'=>(int)$s['course_id'],':stu'=>(int)$s['student_user_id'],':a'=>(int)$s['assignment_id'],':s'=>$submissionId,':score'=>$score,':max'=>$max,':f'=>$in['feedback']??null,':u'=>(int)$user['user_id']]); lms_ok(['saved'=>true]);
