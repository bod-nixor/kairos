<?php
declare(strict_types=1); require_once dirname(__DIR__) . '/_common.php'; $user=lms_require_roles(['ta','manager','admin']); $id=(int)($_GET['submission_id']??0); if($id<=0){lms_error('validation_error','submission_id required',422);} $pdo=db();
$st=$pdo->prepare('SELECT s.submission_id,s.assignment_id,s.course_id,s.student_user_id,s.text_submission,s.status,s.submitted_at,g.grade_id,g.score,g.max_score,g.feedback,g.status AS grade_status FROM lms_submissions s LEFT JOIN lms_grades g ON g.submission_id=s.submission_id WHERE s.submission_id=:id LIMIT 1'); $st->execute([':id'=>$id]); $row=$st->fetch(); if(!$row){lms_error('not_found','Submission not found',404);} if($user['role_name']==='ta'){ $chk=$pdo->prepare('SELECT 1 FROM lms_assignment_tas WHERE assignment_id=:a AND ta_user_id=:u LIMIT 1'); $chk->execute([':a'=>(int)$row['assignment_id'],':u'=>(int)$user['user_id']]); if(!$chk->fetchColumn()){lms_error('forbidden','TA not assigned to this assignment',403);} }
$files=$pdo->prepare('SELECT sf.submission_file_id, sf.resource_id, r.title, r.drive_preview_url, r.mime_type FROM lms_submission_files sf JOIN lms_resources r ON r.resource_id=sf.resource_id WHERE sf.submission_id=:id'); $files->execute([':id'=>$id]); $row['files']=$files->fetchAll(); lms_ok($row);
