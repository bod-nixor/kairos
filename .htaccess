Options -Indexes -MultiViews
RewriteEngine On

# Canonical root entrypoint: send site root to /signoff/ once.
RewriteCond %{REQUEST_URI} ^/$
RewriteRule ^$ /signoff/ [R=302,L]

# --- WebSocket + emit reverse proxy (must be before RewriteBase/other rules) ---

# Proxy WebSocket: /signoff/ws → ws://127.0.0.1:8090/ws
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule ^ws$ ws://127.0.0.1:8090/ws [P,L]

# Proxy emit HTTP: /signoff/emit → http://127.0.0.1:8090/emit
RewriteRule ^emit$ http://127.0.0.1:8090/emit [P,L]

RewriteBase /signoff/

# If someone hits /signoff/public/... force clean URL without /public
RewriteCond %{THE_REQUEST} \s/+signoff/public/ [NC]
RewriteRule ^public/(.*)$ $1 [R=301,L]

# API: map /signoff/api/* -> /signoff/public/api/*
RewriteRule ^api/(.*)$ public/api/$1 [L]

# Pretty pages (no .html in location bar)
RewriteRule ^$ public/index.html [L]
RewriteRule ^ta/?$ public/ta.html [L]
RewriteRule ^manager/?$ public/manager.html [L]
RewriteRule ^admin/?$ public/admin.html [L]
RewriteRule ^room/?$ public/room.html [L]

# Fallback: if not a real file/dir, serve from /public
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ public/$1 [L]

<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  Header always set Cross-Origin-Opener-Policy "same-origin-allow-popups"
  Header always unset Cross-Origin-Embedder-Policy
  Header always unset Cross-Origin-Resource-Policy
</IfModule>